<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aristo Admin | Control Panel</title>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #080808;
            --bg-panel: #141414;
            --bg-hover: #1f1f1f;
            --primary: #bc13fe; /* Neon Purple */
            --accent: #00f3ff; /* Neon Cyan */
            --text-main: #ffffff;
            --text-muted: #888;
            --border: 1px solid #333;
            --success: #00ff88;
            --danger: #ff4757;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 250px; background: var(--bg-panel); border-right: var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px; }
        .nav-link { 
            display: flex; align-items: center; gap: 10px; color: var(--text-muted); 
            text-decoration: none; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; 
            transition: 0.2s; cursor: pointer; 
        }
        .nav-link:hover, .nav-link.active { background: rgba(188, 19, 254, 0.1); color: var(--text-main); }
        .nav-link.active { border-left: 3px solid var(--primary); }

        /* --- Main Content --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn { 
            background: var(--primary); color: white; border: none; padding: 10px 20px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; 
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn-outline { background: transparent; border: 1px solid #444; color: #fff; }
        .btn-danger { background: var(--danger); }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: var(--border); }
        .stat-val { font-size: 2rem; font-weight: 700; margin: 10px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; }

        /* --- Tables --- */
        .table-container { background: var(--bg-panel); border-radius: 12px; border: var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 15px 20px; border-bottom: var(--border); }
        th { color: var(--text-muted); font-weight: 500; font-size: 0.9rem; }
        tr:hover { background: var(--bg-hover); }
        .img-thumb { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; background: #333; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: rgba(0,255,136,0.15); color: var(--success); }
        .badge-yellow { background: rgba(255,200,0,0.15); color: #ffc800; }

        /* --- Modals & Forms --- */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; 
            display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-box { 
            background: var(--bg-panel); width: 600px; max-width: 90%; max-height: 90vh; 
            overflow-y: auto; padding: 25px; border-radius: 12px; border: 1px solid var(--primary); 
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        .form-input, .form-area { 
            width: 100%; background: #000; border: var(--border); padding: 10px; 
            color: white; border-radius: 6px; outline: none; font-family: inherit; 
        }
        .form-input:focus { border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .helper-text { font-size: 0.8rem; color: #666; margin-top: 5px; }

        .hidden { display: none !important; }
        .loader { border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Auth Guard Overlay */
        #auth-guard {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Auth Guard -->
    <div id="auth-guard">
        <div class="loader" style="width: 50px; height: 50px; margin-bottom: 20px;"></div>
        <h3>Verifying Admin Access...</h3>
        <p class="text-muted">If stuck, ensure your user account has 'isAdmin: true' in Firestore.</p>
        <button class="btn btn-outline" style="margin-top:20px;" onclick="location.reload()">Retry</button>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">ARISTO ADMIN</div>
        <nav>
            <div class="nav-link active" onclick="app.nav('dashboard')"><i class="fas fa-chart-line" style="width:20px;"></i> Dashboard</div>
            <div class="nav-link" onclick="app.nav('products')"><i class="fas fa-box" style="width:20px;"></i> Products</div>
            <div class="nav-link" onclick="app.nav('orders')"><i class="fas fa-shopping-cart" style="width:20px;"></i> Orders</div>
            <div class="nav-link" onclick="app.nav('settings')"><i class="fas fa-cog" style="width:20px;"></i> Settings</div>
        </nav>
        <div style="margin-top: auto;">
            <div class="nav-link" style="color: var(--danger)" onclick="auth.signOut()"><i class="fas fa-sign-out-alt" style="width:20px;"></i> Logout</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard">
            <div class="header">
                <h2>Overview</h2>
                <div class="loader hidden" id="dashLoader"></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-val text-primary" id="statRevenue">₹0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Orders</div>
                    <div class="stat-val" id="statOrders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Products</div>
                    <div class="stat-val" id="statProducts">0</div>
                </div>
            </div>
            <div class="table-container" style="padding: 20px; height: 300px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- PRODUCTS VIEW -->
        <div id="view-products" class="hidden">
            <div class="header">
                <h2>Products</h2>
                <button class="btn" onclick="app.openProductModal()"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Img</th><th>Title</th><th>Price</th><th>Stock</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ORDERS VIEW -->
        <div id="view-orders" class="hidden">
            <div class="header">
                <h2>Orders</h2>
                <button class="btn btn-outline" onclick="app.loadOrders()"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th><th>User</th><th>Amount</th><th>Status</th><th>Date</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="hidden">
            <div class="header"><h2>Site Settings</h2></div>
            <div class="stat-card" style="max-width: 800px;">
                <form onsubmit="app.saveSettings(event)">
                    <div class="form-group">
                        <label class="form-label">Site Title</label>
                        <input type="text" class="form-input" id="set-title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Announcements HTML (Banner)</label>
                        <textarea class="form-area" rows="3" id="set-announce"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-input" id="set-email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-input" id="set-phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Razorpay Key ID</label>
                        <input type="text" class="form-input" id="set-rzp" placeholder="Only for reference, update code">
                    </div>
                    <button type="submit" class="btn">Save Configuration</button>
                </form>
            </div>
        </div>
    </main>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-box">
            <h3 id="pModalTitle" style="margin-top:0">Add Product</h3>
            <form onsubmit="app.saveProduct(event)">
                <input type="hidden" id="p-id">
                <div class="form-group">
                    <label class="form-label">Product Title</label>
                    <input type="text" class="form-input" id="p-title" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Price (₹)</label>
                        <input type="number" class="form-input" id="p-price" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-input" id="p-stock" value="100">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-input" id="p-cat" list="cat-list">
                    <datalist id="cat-list">
                        <option value="Electronics"><option value="Digital Art"><option value="Software">
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">Image URL (Direct Link)</label>
                    <input type="url" class="form-input" id="p-img" placeholder="https://freeimage.host/..." required>
                    <div class="helper-text">
                        Use <a href="https://freeimage.host" target="_blank" style="color:var(--accent)">FreeImage.host</a>. Upload -> Copy 'Direct Link'.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (HTML supported)</label>
                    <textarea class="form-area" rows="4" id="p-desc"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="p-visible" checked> Visible on Store
                    </label>
                </div>
                <div class="flex justify-between">
                    <button type="button" class="btn btn-outline" onclick="app.closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION - MUST MATCH USER.HTML
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCkndE5h7HOLTg2xEs7mgKimJIwodApFJs",
            authDomain: "andronix-bcdf7.firebaseapp.com",
            projectId: "andronix-bcdf7",
            storageBucket: "andronix-bcdf7.appspot.com",
            messagingSenderId: "982083836381",
            appId: "1:982083836381:web:88a162ce883e69d2e73e34"
        };
        // ==========================================

        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);
        window.auth = auth; // Expose for logout

        let productsCache = [];
        let ordersCache = [];

        window.app = {
            init: () => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Check Admin Claim
                        try {
                            const uDoc = await getDoc(doc(db, "users", user.uid));
                            if (uDoc.exists() && uDoc.data().isAdmin === true) {
                                document.getElementById('auth-guard').classList.add('hidden');
                                app.loadDashboard();
                            } else {
                                alert("Access Denied: You do not have administrator privileges.");
                                // Optional: signOut(auth);
                            }
                        } catch (e) {
                            console.error(e);
                            alert("Error verifying admin status.");
                        }
                    } else {
                        // Show simple login for admin
                        const email = prompt("Admin Email:");
                        const pass = prompt("Admin Password:");
                        if(email && pass) {
                            signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
                        }
                    }
                });
            },

            nav: (view) => {
                document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                event.currentTarget.classList.add('active'); // simplistic active state
                
                if(view === 'products') app.loadProducts();
                if(view === 'orders') app.loadOrders();
                if(view === 'settings') app.loadSettings();
            },

            // --- Dashboard ---
            loadDashboard: async () => {
                // Quick Stats (Client side calc from fetches for demo)
                const pSnap = await getDocs(collection(db, "products"));
                document.getElementById('statProducts').textContent = pSnap.size;

                const oSnap = await getDocs(query(collection(db, "orders"), limit(100))); // limit for perf
                let revenue = 0;
                let orderCount = oSnap.size;
                const salesData = {};

                oSnap.forEach(d => {
                    const o = d.data();
                    if(o.status === 'paid' || o.status === 'fulfilled') {
                        revenue += o.amount;
                        const date = o.createdAt.toDate().toLocaleDateString();
                        salesData[date] = (salesData[date] || 0) + o.amount;
                    }
                });
                
                document.getElementById('statRevenue').textContent = '₹' + revenue;
                document.getElementById('statOrders').textContent = orderCount;

                // Chart
                const ctx = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(salesData),
                        datasets: [{
                            label: 'Revenue (₹)',
                            data: Object.values(salesData),
                            borderColor: '#bc13fe',
                            backgroundColor: 'rgba(188, 19, 254, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { beginAtZero: true, grid: { color: '#333' } } }
                    }
                });
            },

            // --- Products ---
            loadProducts: async () => {
                const snap = await getDocs(collection(db, "products"));
                productsCache = [];
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';

                snap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    productsCache.push(p);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><img src="${p.thumbnails?.[0] || ''}" class="img-thumb"></td>
                        <td>${p.title}</td>
                        <td>₹${p.price}</td>
                        <td>${p.stock}</td>
                        <td>
                            <button class="btn btn-outline" style="padding:5px 10px;" onclick="app.editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" style="padding:5px 10px;" onclick="app.deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            openProductModal: () => {
                document.getElementById('p-id').value = '';
                document.getElementById('pModalTitle').textContent = 'Add Product';
                document.querySelector('#productModal form').reset();
                document.getElementById('productModal').classList.add('open');
            },

            editProduct: (id) => {
                const p = productsCache.find(x => x.id === id);
                if(!p) return;
                document.getElementById('p-id').value = p.id;
                document.getElementById('p-title').value = p.title;
                document.getElementById('p-price').value = p.price;
                document.getElementById('p-stock').value = p.stock;
                document.getElementById('p-cat').value = p.category;
                document.getElementById('p-img').value = p.thumbnails?.[0] || '';
                document.getElementById('p-desc').value = p.description || '';
                document.getElementById('p-visible').checked = p.visible;
                document.getElementById('pModalTitle').textContent = 'Edit Product';
                document.getElementById('productModal').classList.add('open');
            },

            saveProduct: async (e) => {
                e.preventDefault();
                const id = document.getElementById('p-id').value;
                const data = {
                    title: document.getElementById('p-title').value,
                    price: Number(document.getElementById('p-price').value),
                    stock: Number(document.getElementById('p-stock').value),
                    category: document.getElementById('p-cat').value,
                    thumbnails: [document.getElementById('p-img').value], // Simple single image logic
                    description: document.getElementById('p-desc').value,
                    visible: document.getElementById('p-visible').checked,
                    updatedAt: new Date()
                };

                if(id) {
                    await updateDoc(doc(db, "products", id), data);
                } else {
                    data.createdAt = new Date();
                    await addDoc(collection(db, "products"), data);
                }
                app.closeModal();
                app.loadProducts();
            },

            deleteProduct: async (id) => {
                if(confirm("Are you sure?")) {
                    await deleteDoc(doc(db, "products", id));
                    app.loadProducts();
                }
            },

            closeModal: () => document.getElementById('productModal').classList.remove('open'),

            // --- Orders ---
            loadOrders: async () => {
                const q = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(50));
                const snap = await getDocs(q);
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';

                snap.forEach(docSnap => {
                    const o = docSnap.data();
                    const tr = document.createElement('tr');
                    const badgeClass = o.status === 'paid' ? 'badge-green' : 'badge-yellow';
                    tr.innerHTML = `
                        <td>${docSnap.id.slice(0,6)}...</td>
                        <td>${o.userId.slice(0,5)}...</td>
                        <td>₹${o.amount}</td>
                        <td><span class="badge ${badgeClass}">${o.status}</span></td>
                        <td>${o.createdAt?.toDate().toLocaleDateString()}</td>
                        <td>
                            ${o.status !== 'paid' ? `<button class="btn btn-outline" style="font-size:0.7rem" onclick="app.markPaid('${docSnap.id}')">Mark Paid</button>` : '<i class="fas fa-check text-success"></i>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            markPaid: async (oid) => {
                if(confirm("Manually mark as paid?")) {
                    await updateDoc(doc(db, "orders", oid), { status: 'paid', manuallyUpdated: true });
                    app.loadOrders();
                }
            },

            // --- Settings ---
            loadSettings: async () => {
                const d = await getDoc(doc(db, "siteSettings", "config"));
                if(d.exists()) {
                    const s = d.data();
                    document.getElementById('set-title').value = s.siteTitle || '';
                    document.getElementById('set-announce').value = s.announcementsHtml || '';
                    document.getElementById('set-email').value = s.contactEmail || '';
                    document.getElementById('set-phone').value = s.contactPhone || '';
                }
            },

            saveSettings: async (e) => {
                e.preventDefault();
                const data = {
                    siteTitle: document.getElementById('set-title').value,
                    announcementsHtml: document.getElementById('set-announce').value,
                    contactEmail: document.getElementById('set-email').value,
                    contactPhone: document.getElementById('set-phone').value
                };
                await setDoc(doc(db, "siteSettings", "config"), data, { merge: true });
                alert("Settings Saved!");
            }
        };

        // Start
        app.init();
    </script>
</body>
</html>

